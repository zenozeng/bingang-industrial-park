var Data,Gallery,Router,View,WP,config,data,fn,gallery,route,router,routes,view,__slice=[].slice;WP=function(){function WP(url,opts){var key,value;this.url=url;this.opts={useFakeData:false,postPerPage:10,useComments:false};if(opts){for(key in opts){value=opts[key];this.opts[key]=value}}}WP.prototype.get=function(){var args,callback,method,obj,_i;method=arguments[0],obj=3<=arguments.length?__slice.call(arguments,1,_i=arguments.length-1):(_i=1,[]),callback=arguments[_i++];obj=obj.length>0?obj[0]:{};if(this.opts.useFakeData){return fake(method,obj,callback)}obj.json=method?method:1;args={type:"get",url:this.url,dataType:"jsonp",jsonp:"callback",data:obj,success:callback};return $.ajax(args)};WP.prototype.fake=function(method,obj,callback){if(method==="get_recent_posts"){method="get_posts"}return $.get("fake/"+method+".json",callback)};WP.prototype.post=function(id,callback){return this.get("get_post",{post_id:id},function(data){return callback(data.post)})};WP.prototype.posts=function(){var args,callback,method,page,_i;args=arguments[0],page=3<=arguments.length?__slice.call(arguments,1,_i=arguments.length-1):(_i=1,[]),callback=arguments[_i++];if(JSON.stringify(args==="{}")){method="get_recent_posts"}else{method="get_posts"}args.posts_per_page=this.opts.postsPerPage;if(page.length>0){args.paged=page[0]}return this.get(method,args,callback)};WP.prototype.categorie=function(){var callback,page,title,_i,_this=this;title=arguments[0],page=3<=arguments.length?__slice.call(arguments,1,_i=arguments.length-1):(_i=1,[]),callback=arguments[_i++];return this.categories(function(categories){var categorie,id,_j,_len,_results;_results=[];for(_j=0,_len=categories.length;_j<_len;_j++){categorie=categories[_j];if(categorie.title===title){id=categorie.id;_results.push(_this.posts({cat:id},page[0],callback))}else{_results.push(void 0)}}return _results})};WP.prototype.tag=function(){var callback,page,title,_i,_this=this;title=arguments[0],page=3<=arguments.length?__slice.call(arguments,1,_i=arguments.length-1):(_i=1,[]),callback=arguments[_i++];return this.tags(function(tags){var id,tag,_j,_len,_results;_results=[];for(_j=0,_len=tags.length;_j<_len;_j++){tag=tags[_j];if(tag.title===title){id=tag.id;_results.push(_this.posts({tag_id:id},page[0],callback))}else{_results.push(void 0)}}return _results})};WP.prototype.search=function(){var callback,keyword,page,_i;keyword=arguments[0],page=3<=arguments.length?__slice.call(arguments,1,_i=arguments.length-1):(_i=1,[]),callback=arguments[_i++];return this.posts({s:keyword},page[0],callback)};WP.prototype.categories=function(callback){return this.get("get_category_index",function(obj){return callback(obj.categories)})};WP.prototype.tags=function(callback){return this.get("get_tag_index",function(obj){return callback(obj.tags)})};WP.prototype.comment=function(postId,name,email,content,callback){var args;args={post_id:postId,name:name,email:email,content:content};return this.get("respond.submit_comment",args,callback)};WP.prototype.getExtra=function(method,data,callback){var args;data.jsonextra=method;args={type:"get",url:this.url,dataType:"jsonp",jsonp:"callback",data:data,success:callback};return $.ajax(args)};WP.prototype.lastModified=function(callback){return this.getExtra("lastModified",{},callback)};return WP}();config={uyanHTML:'<div id="uyan_frame"></div>    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1822392"></script>',wpUrl:"http://61.153.203.166/",baseUrl:"http://bgic.cn/",indexImagesJSONP:"http://61.153.203.166/?page_id=7&json=1",linksJSONP:"http://61.153.203.166/?page_id=12&json=1",indexSections:["动态信息","通知公告","发展规划","政府公文","入区企业"]};Data=function(){function Data(url,opts){var _this=this;this.url=url;this.wp=new WP(this.url);this.updateList=[];this.wp.lastModified(function(data){var updateArgs,_i,_len,_ref,_results;_this.lastModified=data.lastModified;_ref=_this.updateList;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){updateArgs=_ref[_i];_results.push(_this.update.apply(_this,updateArgs))}return _results});this.cache={};this.cacheKeyPrefix="bingang";this.useLocalStorage=true;if(window.localStorage==null){this.useLocalStorage=false}this.debug=false;this.events={}}Data.prototype.on=function(event,callback){if(this.events[event]==null){this.events[event]={callbacks:[]}}return this.events[event].callbacks.push(callback)};Data.prototype.trigger=function(event,args){var callback,_i,_len,_ref,_results;if(this.events[event]!=null){_ref=this.events[event].callbacks;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){callback=_ref[_i];_results.push(callback(args))}return _results}};Data.prototype.save=function(cacheKey,data){var key,post,_i,_len,_ref,_results;if(data!=null&&data.posts!=null){_ref=data.posts;for(_i=0,_len=_ref.length;_i<_len;_i++){post=_ref[_i];this.save('post:["'+post.id+'"]',post)}}if(cacheKey.indexOf(this.cacheKeyPrefix)!==0){cacheKey=this.cacheKeyPrefix+":"+cacheKey}if(this.debug){console.log("save:"+cacheKey)}this.cache[cacheKey]=data;data={data:data,timestamp:this.lastModified};if(this.debug){console.log(data)}if(this.useLocalStorage){try{return localStorage.setItem(cacheKey,JSON.stringify(data))}catch(e){if(e.name==="QUOTA_EXCEEDED_ERR"){_results=[];for(key in localStorage){if(key.indexOf(this.cacheKeyPrefix)===0){_results.push(localStorage.removeItem(key))}else{_results.push(void 0)}}return _results}}}};Data.prototype.update=function(cacheKey,fetch,parse){var cacheItem,cacheTime,_this=this;if(this.lastModified!=null){if(this.debug){console.log("testUpdate:"+cacheKey)}cacheItem=JSON.parse(localStorage.getItem(cacheKey));cacheTime=cacheItem&&cacheItem.timestamp!=null?cacheItem.timestamp:0;if(this.debug){console.log([cacheTime,this.lastModified,cacheTime-this.lastModified])}if(cacheTime>=this.lastModified){return}if(this.debug){console.log("update:"+cacheKey)}return fetch(function(data){data=parse?parse(data):data;_this.save(cacheKey,data);return _this.trigger("update",{cacheKey:cacheKey})})}else{return this.updateList.push([cacheKey,fetch,parse])}};Data.prototype.fetch=function(){var cacheKey,callback,fetch,parse,_i,_this=this;cacheKey=arguments[0],fetch=arguments[1],parse=4<=arguments.length?__slice.call(arguments,2,_i=arguments.length-1):(_i=2,[]),callback=arguments[_i++];if(cacheKey.indexOf(this.cacheKeyPrefix)!==0){cacheKey=this.cacheKeyPrefix+":"+cacheKey}if(this.cache[cacheKey]){if(this.debug){console.log("RAM:"+cacheKey)}return callback(this.cache[cacheKey])}else{if(this.useLocalStorage&&localStorage.getItem(cacheKey)&&JSON.parse(localStorage.getItem(cacheKey)).timestamp){if(this.debug){console.log("localStorage:"+cacheKey)}callback(JSON.parse(localStorage.getItem(cacheKey)).data);return this.update(cacheKey,fetch,parse[0])}else{if(this.debug){console.log("fetch:"+cacheKey)}return fetch(function(data){data=parse[0]?parse[0](data):data;callback(data);return _this.update(cacheKey,function(fn){return fn(data)})})}}};Data.prototype.get=function(){var args,cacheKey,callback,fetch,fn,keyArgs,method,_i,_this=this;method=arguments[0],args=3<=arguments.length?__slice.call(arguments,1,_i=arguments.length-1):(_i=1,[]),callback=arguments[_i++];fn=callback;if(method==="imgs"){return this.imgs(callback)}if(method==="links"){return this.links(callback)}keyArgs=args.filter(function(arg){return typeof arg!=="function"});cacheKey=method+":"+JSON.stringify(keyArgs);fetch=function(callback){args.push(callback);return _this.wp[method].apply(_this.wp,args)};return this.fetch(cacheKey,fetch,null,callback)};Data.prototype.imgs=function(callback){var cacheKey,fetch,parse;cacheKey="imgs";fetch=function(callback){var args;args={type:"get",url:config.indexImagesJSONP,dataType:"jsonp",jsonp:"callback",success:callback};return $.ajax(args)};parse=function(data){var html,images,regexp;html=data.page.content;regexp=new RegExp('src="([^"]*)"',"g");images=html.match(regexp);return images=images.map(function(html){return html.replace(new RegExp('(src=|")',"g"),"")})};return this.fetch(cacheKey,fetch,parse,callback)};Data.prototype.links=function(callback){var cacheKey,fetch,parse;cacheKey="links";fetch=function(callback){var args;args={type:"get",url:config.linksJSONP,dataType:"jsonp",jsonp:"callback",success:callback};return $.ajax(args)};parse=function(data){var links,regexp;regexp=new RegExp("<a[^<>]*>[^<>]*</a>","g");return links=data.page.content.match(regexp)};return this.fetch(cacheKey,fetch,parse,callback)};return Data}();data=new Data(config.wpUrl);Gallery=function(){function Gallery(){this.readyCallbacks=[];this.imgs=[];this.width=900;this.height=360;this.loaded=false}Gallery.prototype.set=function(imgs){var callback,_i,_len,_ref;this.imgs=imgs;_ref=this.readyCallbacks;for(_i=0,_len=_ref.length;_i<_len;_i++){callback=_ref[_i];this.ready(callback)}return this.readyCallbacks=[]};Gallery.prototype.ready=function(callback){if(this.imgs.length>0){return typeof callback==="function"?callback():void 0}else{return this.readyCallbacks.push(callback)}};Gallery.prototype.start=function(){var show,_this=this;show=function(){var interval;$("#gallery #img").html('<img src="'+_this.imgs[0]+'" alt="gallery-img">');_this.count++;interval=function(){return function(that){return that.next()}(_this)};if(_this.interval!=null){clearInterval(_this.interval)}_this.interval=setInterval(interval,3e3);return _this.setImgScale(function(){if(!$("#gallery").is(":visible")){return $("#gallery").slideDown()}})};return this.ready(function(){var img;_this.count=0;if(_this.loaded){return show()}else{img=new Image;img.src=_this.imgs[0];return img.onload=function(){_this.loaded=true;return show()}}})};Gallery.prototype.close=function(){$("#gallery").hide();if(this.interval!=null){return clearInterval(this.interval)}};Gallery.prototype.preload=function(){var nextImage;if(this.count<this.imgs.length){nextImage=this.imgs[this.count];return(new Image).src=nextImage}};Gallery.prototype.next=function(){var img,index,_this=this;index=this.count%this.imgs.length;img=this.imgs[index];this.count++;return $("#gallery #img").fadeOut(400,function(){$("#gallery #img").html('<img src="'+img+'" alt="gallery-img">');return _this.setImgScale(function(){$("#gallery #img").fadeIn(400);return _this.preload()})})};Gallery.prototype.setImgScale=function(callback){var $this,that;$this=$("#gallery #img img");that=this;return $this.attr("src",$(this).attr("src")).load(function(){var boxHeight,boxScale,boxWidth,imgHeight,imgScale,imgWidth,left,newHeight,newWidth,top;$this=$("#gallery #img img");imgWidth=this.width;imgHeight=this.height;imgScale=imgWidth/imgHeight;boxWidth=that.width;boxHeight=that.height;boxScale=boxWidth/boxHeight;if(imgScale>boxScale){$this.height(boxHeight);newWidth=boxHeight/imgHeight*imgWidth;left=(newWidth-boxWidth)/2;$this.css({height:boxHeight,width:"auto",left:-left,top:0})}else{newHeight=boxWidth/imgWidth*imgHeight;top=(newHeight-boxHeight)/2;$this.css({height:"auto",width:boxWidth,left:0,top:-top})}return typeof callback==="function"?callback():void 0})};return Gallery}();gallery=new Gallery;data.get("imgs",function(imgs){return gallery.set(imgs)});View=function(){function View(){var _this=this;this.events={};this.data=data;this.loading();this.data.get("categories",function(categories){var html;html=categories.map(function(cat){return'<li class="categorie">          <a href="#!/categorie/'+cat.title+'">'+cat.title+"</a>        </li>"});return $("nav ul").html(html)});this.data.on("update",function(args){return _this.refresh()});this.on("updateneeded",function(args){_this.loading();if(args.to!=="post"){_this.resetUyan()}if(args.to!=="index"){return gallery.close()}})}View.prototype.loading=function(){return $("main").html('<div id="loading"><i>Loading</i><span id="bubblingG_1"></span><span id="bubblingG_2"></span><span id="bubblingG_3"></span></div>')};View.prototype.on=function(event,callback){if(this.events[event]==null){this.events[event]={callbacks:[]}}return this.events[event].callbacks.push(callback)};View.prototype.trigger=function(event,args){var callback,_i,_len,_ref,_results;if(this.events[event]!=null){_ref=this.events[event].callbacks;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){callback=_ref[_i];_results.push(callback(args))}return _results}};View.prototype.current=function(view){if(view){$("main").attr("id",view);this.trigger("updateneeded",{from:this.currentView,to:view});return this.currentView=view}else{return this.currentView}};View.prototype.resetUyan=function(callback){var pending,resetVars,scripts;resetVars=function(){var v,_i,_len,_ref;_ref=["_config","_loaded","_c_g","_s_g","_style_loaded","_style_loaded_over"];for(_i=0,_len=_ref.length;_i<_len;_i++){v=_ref[_i];window["uyan"+v]=void 0}return window.uyan_config={title:$("title").text()+" #滨港工业城#",url:config.baseUrl+window.location.hash,su:window.location.hash?window.location.hash.replace("#",""):"滨港工业城"}};scripts=$("head script");pending=scripts.length;if(pending===0){resetVars();return typeof callback==="function"?callback():void 0}else{return scripts.each(function(){var id,src;pending--;src=$(this).attr("src");id=$(this).attr("id");if(src&&src.indexOf("uyan")>-1||id&&id.indexOf("uyan")>-1){$(this).remove()}if(pending===0){resetVars();return typeof callback==="function"?callback():void 0}})}};View.prototype.sidebar=function(callback){return this.data.get("links",function(links){links=links.map(function(link){return"<li>"+link+"</li>"});links=links.join("");return callback('<div id="sidebar">        <div id="search">          <h2><i class="icon-search"></i>全站搜索</h2>          <div id="search-box">            <input id="search-input" type="text">            <i class="icon-search"></i>          </div>        </div>        <div id="admin">          <h2><i class="icon-cogs"></i>后台管理</h2>          <ul>            <li><a href="'+config.wpUrl+'wp-admin/">后台管理</a></li>            <li><a href="http://www.uyan.cc/sites">评论管理</a></li>          </ul>        </div>        <div id="links">          <h2><i class="icon-external-link"></i>友情链接</h2>          <ul>'+links+"</ul>        </div>      </div>")})};View.prototype.pageNav=function(sum,current){var html,left,maxPageDistance,navs,right,_i,_j,_k,_l,_m,_ref,_ref1,_results,_results1,_results2,_results3,_results4,_this=this;if(!(sum>1)){return""}maxPageDistance=3;if(sum<=maxPageDistance*2){navs=function(){_results=[];for(var _i=1;1<=sum?_i<=sum:_i>=sum;1<=sum?_i++:_i--){_results.push(_i)}return _results}.apply(this)}else{if(current-1>maxPageDistance){left=[1,"..."];left=left.concat(function(){_results1=[];for(var _j=_ref=current-maxPageDistance;_ref<=current?_j<current:_j>current;_ref<=current?_j++:_j--){_results1.push(_j)}return _results1}.apply(this))}else{left=function(){_results2=[];for(var _k=1;1<=current?_k<current:_k>current;1<=current?_k++:_k--){_results2.push(_k)}return _results2}.apply(this)}if(sum-current>maxPageDistance){right=function(){_results3=[];for(var _l=current,_ref1=current+maxPageDistance;current<=_ref1?_l<=_ref1:_l>=_ref1;current<=_ref1?_l++:_l--){_results3.push(_l)}return _results3}.apply(this);right=right.concat(["...",sum])}else{right=function(){_results4=[];for(var _m=current;current<=sum?_m<=sum:_m>=sum;current<=sum?_m++:_m--){_results4.push(_m)}return _results4}.apply(this)}navs=left.concat(right)}html=navs.map(function(i){var extraClass,href,page,prefix;prefix=_this.current()==="index"?"#!/page/":"#!/"+_this.current()+"/"+router.args[0]+"/";page=i==="..."?current:parseInt(i);href=prefix+page;extraClass=i===current?" current":"";return'<li class="page'+extraClass+'"><a href="'+href+'">'+i+"</a></li>"});return'<nav class="page-nav"><ul>'+html.join("")+"</ul></nav>"};View.prototype.list=function(container,posts,currentPage){var pages,_this=this;currentPage=currentPage!=null?parseInt(currentPage):1;pages=posts.pages;posts=posts.posts;if(posts.length===0){return this.error()}posts=posts.map(function(post){return'<article class="article">      <header>        <a href="#!/archives/'+post.id+'"><span class="date">'+post.date.substring(0,10)+"</span> "+post.title+"</a>      </header>    </article>"});return this.sidebar(function(html){html+='<div id="sections">        <section class="section">          <header><h1>'+_this.current()+": "+router.args[0]+"</h1></header>          "+posts.join("")+"          "+_this.pageNav(pages,currentPage)+"        </section>      </div>";return $("#"+container).html(html)})};View.prototype.error=function(title,msg){var html;if(!(title!=null||msg!=null)){title="404：没有找到您要找的内容";msg='请点击 <a href="#">这里</a> 返回首页'}this.current("error");html='<div id="error"><h1>'+title+"</h1><p>"+msg+"</p></div>";return $("#error").html(html)};View.prototype.post=function(id){var _this=this;this.current("post");return this.resetUyan(function(){return _this.data.get("post",id,function(post){var html;if(!post){return _this.error()}html='<article class="single">          <header>            <h1>              <a href="#!/archives/'+post.id+'">'+post.title+'</a>            </h1>          </header>          <div class="content">'+post.content+'</div>          <footer id="comments">'+config.uyanHTML+"</footer>        </article>";return $("#post").html(html)})})};View.prototype.index=function(){var page,sections,_this=this;page=1<=arguments.length?__slice.call(arguments,0):[];this.current("index");gallery.start();sections=function(callback){var html,loaded,section,_i,_len,_ref,_results;window.indexSectionsPending=config.indexSections.length;html="";loaded=function(){window.indexSectionsPending--;if(window.indexSectionsPending===0){return typeof callback==="function"?callback(html):void 0}};_ref=config.indexSections;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){section=_ref[_i];_results.push(_this.data.get("categorie",section,function(data){var posts;posts=data.posts;posts=posts.map(function(post){return'<article class="article">            <header>              <a href="#!/archives/'+post.id+'"><span class="date">'+post.date.substring(0,10)+"</span> "+post.title+"</a>            </header>          </article>"});html+='<section class="section"><header><h1>'+section+"</h1></header>"+posts.join("")+"</section>";return loaded()}))}return _results};return sections(function(data){return _this.sidebar(function(html){html+='<div id="sections">'+data+"</div>";return $("#index").html(html)})})};View.prototype.categorie=function(){var categorie,page,_this=this;categorie=arguments[0],page=2<=arguments.length?__slice.call(arguments,1):[];this.current("categorie");return this.data.get("categorie",categorie,page[0],function(posts){return _this.list("categorie",posts,page[0])})};View.prototype.search=function(){var keyword,page,_this=this;keyword=arguments[0],page=2<=arguments.length?__slice.call(arguments,1):[];this.current("search");return this.data.get("search",keyword,page[0],function(posts){return _this.list("search",posts,page[0])})};View.prototype.refresh=function(){return router.apply()};return View}();view=new View;$(function(){var submitSearch;submitSearch=function(){var keyword;keyword=$("#search-input").val();if(!(keyword.length>0)){return}return router.navigate("#!/search/"+keyword)};$("body").on("click","#search-box i",submitSearch);return $("body").on("keydown","#search-input",function(e){if(e.keyCode===13){return submitSearch()}})});Router=function(){function Router(){var _this=this;this.routes={};$(window).on("hashchange",function(){return _this.apply()})}Router.prototype.add=function(route,callback){route=route.replace(new RegExp(":\\w+","g"),"([^/]+)");return this.routes["^"+route+"$"]=callback};Router.prototype.navigate=function(url){url=url.split("#").pop();return window.location.hash="#"+url};Router.prototype.current=function(){return window.location.hash};Router.prototype.apply=function(){var fn,path,reg,regexp,_ref,_results;path=window.location.hash.toString().split("#").pop();_ref=this.routes;_results=[];for(reg in _ref){fn=_ref[reg];regexp=new RegExp(reg);if(regexp.test(path)){this.args=regexp.exec(path).slice(1);_results.push(fn.apply(window,this.args))}else{_results.push(void 0)}}return _results};return Router}();router=new Router;routes={"":function(){return view.index()},"!/page/:page":function(page){return view.index(page)},"!/archives/:id":function(id){return view.post(id)},"!/search/:query":function(query){return view.search(query)},"!/search/:query/:page":function(query,page){return view.search(query,page)},"!/tag/:tag":function(tag){return view.tag(tag)},"!/tag/:tag/:page":function(tag,page){return view.tag(tag,page)},"!/categorie/:cat":function(cat){return view.categorie(cat)},"!/categorie/:cat/:page:":function(cat,page){return view.categorie(cat,page)},"!/error":function(){return view.error()}};for(route in routes){fn=routes[route];router.add(route,fn)}router.apply();$("body").on("click","a",function(e){var href;href=$(this).attr("href");if(!href){return}e.preventDefault();e.stopPropagation();if(href.indexOf("#")===0){return router.navigate(href)}else{return window.location.href=href}});